<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Paperless — Documents</title>
    <style>
        :root {
            --bg: #f7f7fb;
            --card: #ffffff;
            --ink: #1f2937;
            --muted: #6b7280;
            --brand: #6d28d9;
            --brand-weak: #ede9fe;
            --ring: 0 0 0 4px rgba(109,40,217,.15);
            --radius: 16px;
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
            color: var(--ink);
            background: linear-gradient(180deg,#fafafe, var(--bg));
        }

        .wrap {
            max-width: 1100px;
            margin: 0 auto;
            padding: 24px
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 20px
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            font-size: 24px;
        }

        .logo {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: conic-gradient(from 200deg at 50% 50%, #a78bfa, #c084fc, #f472b6, #a78bfa);
            box-shadow: 0 6px 18px rgba(109,40,217,.25);
        }

        .chip {
            font-size: 13px;
            border-radius: 999px;
            padding: 6px 10px;
            background: var(--brand-weak);
            color: var(--brand);
            border: 1px solid #e9e4ff;
        }

        .grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
        }

        @media (max-width:900px) {
            .grid {
                grid-template-columns: 1fr
            }
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(17,24,39,.06);
            border: 1px solid #eef;
            padding: 18px;
        }

            .card h2 {
                margin: 0 0 10px 0;
                font-size: 18px
            }

        .muted {
            color: var(--muted)
        }

        .upload-box {
            border: 2px dashed #ddd;
            border-radius: 14px;
            padding: 18px;
            text-align: center;
            background: #fcfcff;
            transition: border-color .15s ease, background .15s ease;
        }

            .upload-box.dragover {
                border-color: #c4b5fd;
                background: #f6f5ff;
                box-shadow: var(--ring);
            }

        .upload-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            appearance: none;
            border: 0;
            background: var(--brand);
            color: white;
            border-radius: 12px;
            padding: 10px 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(109,40,217,.25);
        }

            .btn:disabled {
                opacity: .5;
                cursor: not-allowed;
            }

        .btn-ghost {
            background: #f3f0ff;
            color: #4c1d95;
            box-shadow: none;
            border: 1px solid #e9e4ff;
        }

        .queue {
            margin-top: 12px;
            display: grid;
            gap: 8px;
        }

        .q-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
            padding: 10px;
            border: 1px solid #eef;
            border-radius: 12px;
            background: white;
        }
            .q-item strong {
                display: inline-block;
                max-width: 180px; 
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap; 
                vertical-align: middle;
            }


        .list {
            display: grid;
            grid-template-columns: repeat(auto-fill,minmax(260px,1fr));
            gap: 14px
        }

        .doc {
            position: relative;
            border: 1px solid #eef;
            border-radius: 14px;
            padding: 14px;
            background: white;
            display: flex;
            gap: 12px;
            align-items: flex-start;
            flex-wrap: wrap; 
            transition: transform .08s ease, box-shadow .08s ease;
        }

            .doc:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 24px rgba(17,24,39,.08)
            }

            .doc .icon {
                width: 36px;
                height: 36px;
                border-radius: 10px;
                background: #eef;
                display: grid;
                place-items: center;
                font-weight: 800;
                color: #6b21a8;
                flex: 0 0 36px;
            }

            .doc .meta {
                font-size: 12px;
                color: var(--muted)
            }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        .pill {
            font-size: 11px;
            border-radius: 999px;
            padding: 3px 8px;
            background: #f3f4f6;
            border: 1px solid #eee
        }

        .ocr-result {
            background: #f5f3ff;
            border: 1px solid #e9d5ff;
            border-radius: 10px;
            padding: 6px 10px;
            font-size: 13px;
            color: #4c1d95;
            margin-top: 8px;
            white-space: pre-wrap;
        }

        .del {
            position: absolute;
            top: 8px;
            right: 8px;
            border: 1px solid #fee2e2;
            background: #fff5f5;
            color: #b91c1c;
            border-radius: 10px;
            padding: 6px 8px;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

            .del:hover {
                background: #ffe4e6;
                box-shadow: 0 4px 14px rgba(239,68,68,.18);
            }

            .del:focus {
                outline: none;
                box-shadow: 0 0 0 4px rgba(239,68,68,.15);
            }

        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            min-width: 260px;
            background: #1f1f29;
            color: white;
            padding: 14px 20px;
            border-radius: 14px;
            box-shadow: 0 10px 30px rgba(0,0,0,.25);
            opacity: 0;
            pointer-events: none;
            transform: translateY(-20px);
            transition: opacity .25s ease, transform .25s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9999;
        }

            .toast.show {
                opacity: 1;
                transform: translateY(0);
            }

        .toast-large {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast-spinner {
            width: 18px;
            height: 18px;
            border: 3px solid #c8b5ff;
            border-top-color: #7d3aed;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }


        .empty {
            padding: 24px;
            text-align: center;
            border: 1px dashed #e5e7eb;
            border-radius: 14px;
            background: #fff;
        }

        .doc .doc-link {
            display: inline-block;
            max-width: 200px; 
            word-break: break-word; 
            white-space: normal; 
        }

        a.doc-link {
            color: inherit;
            text-decoration: none
        }

        footer {
            margin-top: 26px;
            font-size: 12px;
            color: var(--muted);
            text-align: center
        }

        .del:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            box-shadow: none !important;
            background: #fce7e7 !important;
            color: #b91c1c80;
            pointer-events: none;
        }

        .ocr-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            color: #6a1b9a;
            font-weight: 500;
            margin-top: 10px;
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 3px solid #d1c4e9;
            border-top-color: #6a1b9a;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .toast-large {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            border-radius: 14px;
        }

        .toast-spinner {
            width: 18px;
            height: 18px;
            border: 3px solid #d1c4e9;
            border-top-color: #6a1b9a;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        main.card {
            max-height: 78vh;
            display: flex;
            flex-direction: column;
        }

        #docs {
            overflow-y: auto;
            max-height: 100%;
            padding-right: 6px;
        }

        #docs::-webkit-scrollbar {
            width: 8px;
        }

        #docs::-webkit-scrollbar-track {
            background: #f7f4ff;
            border-radius: 10px;
        }

        #docs::-webkit-scrollbar-thumb {
            background: #c5b7ff;
            border-radius: 10px;
        }

        #docs::-webkit-scrollbar-thumb:hover {
            background: #a78bfa;
        }

        #docs {
            scrollbar-width: thin;
            scrollbar-color: #c5b7ff #f7f4ff;
        }


    </style>
</head>
<body>
    <div class="wrap">
        <header style="gap: 16px; display: flex; align-items: center; justify-content: space-between;">
            <div class="brand">
                <div class="logo" aria-hidden="true"></div>
                <div>Paperless</div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="position: relative;">
                                <input id="searchInput" type="text" placeholder="Search…" style="
                      padding: 8px 28px 8px 10px;
                      border: 1px solid #ddd;
                      border-radius: 8px;
                      font-size: 14px;" />
                   <button id="clearSearchBtn" style="
                      position: absolute;
                      right: 6px;
                      top: 50%;
                      transform: translateY(-50%);
                      background: none;
                      border: none;
                      font-size: 16px;
                      color: #aaa;
                      cursor: pointer;
                  " aria-label="Clear search">
                                    ✕
                    </button>
                </div>
                <div id="status" class="chip">Checking API…</div>
            </div>
        </header>


        <div class="grid">
            <aside class="card">
                <h2>Upload</h2>
                <p class="muted">Choose files or drag them into the box. Multiple files supported.</p>

                <div id="drop" class="upload-box" tabindex="0" aria-label="Upload files by dragging and dropping or using the button">
                    <div style="font-size:36px;line-height:1">📄⬆️</div>
                    <div style="font-weight:600;margin-top:6px">Drag & drop files</div>
                    <div class="muted" style="font-size:12px">PDF, PNG, JPG • Max 10 MB</div>
                    <div class="upload-actions">
                        <input id="file" type="file" multiple hidden accept=".pdf,.png,.jpg,.jpeg,.gif,.webp" />
                        <button id="choose" class="btn-ghost btn" type="button">Choose files…</button>
                        <button id="start" class="btn" type="button" disabled>Upload</button>
                    </div>
                </div>
                <div id="queue" class="queue" aria-live="polite"></div>

            </aside>
            <main class="card">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px">
                    <h2 style="margin:0">Your Documents</h2>
                    <div class="pill" id="count">0 items</div>
                </div>
                <div id="docs" class="list" aria-live="polite" aria-busy="true"></div>
            </main>
        </div>

        <footer>Paperless Web</footer>
    </div>

    <div id="ocr-result-box" style="margin: 40px 0 20px 0; padding: 20px; border-radius: 12px; background: #f5f5f5; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
        <h2 style="margin-top: 20px; color: #444;">Summary</h2>
        <pre id="summary-result-text" style="white-space: pre-wrap; font-family: monospace; color: #333;">
             No summary available
            </pre>

        <h2 style="margin-bottom: 10px; color: #444;">OCR Result</h2>
        <pre id="ocr-result-text" style="white-space: pre-wrap; font-family: monospace; color: #333;">
             No OCR Request
            </pre>

    </div>


    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script>
        const statusEl = document.getElementById('status');
        const listEl = document.getElementById('docs');
        const countEl = document.getElementById('count');

        const dropEl = document.getElementById('drop');
        const fileInput = document.getElementById('file');
        const chooseBtn = document.getElementById('choose');
        const startBtn = document.getElementById('start');
        const queueEl = document.getElementById('queue');

        const toastEl = document.getElementById('toast');

        const ocrResultBox = document.getElementById('ocr-result-box');
        const ocrResultText = document.getElementById('ocr-result-text');
        const summaryResultText = document.getElementById('summary-result-text');
        const ocrLoading = document.getElementById('ocr-loading');


        function toast(msg, duration = 2000) {
            toastEl.innerHTML = `<span>${msg}</span>`;
            toastEl.classList.add('show');

            setTimeout(() => {
                toastEl.classList.remove('show');
            }, duration);
        }

        function showOcrToast(message) {
            toastEl.innerHTML = `
        <div class="toast-large">
            <div class="toast-spinner"></div>
            <span>${message}</span>
        </div>`;
            toastEl.classList.add('show');
        }

        function hideOcrToast() {
            toastEl.classList.remove('show');
            setTimeout(() => (toastEl.innerHTML = ""), 200);
        }


        function showGlobalOcrResult(text, filename) {
            ocrResultText.textContent = text || '(no OCR text)';
            ocrResultBox.scrollIntoView({ behavior: 'smooth' });
            toast(`OCR done for ${filename}`);
        }

        function fmtBytes(n) {
            if (!Number.isFinite(n)) return '-';
            const u = ['B', 'KB', 'MB', 'GB']; let i = 0;
            while (n >= 1024 && i < u.length - 1) { n /= 1024; i++; }
            return n.toFixed(n < 10 && i > 0 ? 1 : 0) + ' ' + u[i];
        }
        function fmtDate(s) {
            const d = new Date(s);
            if (isNaN(d)) return '-';
            return d.toLocaleString();
        }
        function extIcon(name, contentType) {
            const ext = (name?.split('.').pop() || '').toLowerCase();
            if (contentType?.includes('pdf') || ext === 'pdf') return 'PDF';
            if (['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(ext)) return 'IMG';
            if (['doc', 'docx'].includes(ext)) return 'DOC';
            if (['xls', 'xlsx', 'csv'].includes(ext)) return 'XLS';
            return 'FILE';
        }

        async function apiDeleteDocument(id) {
            const res = await fetch(`/api/documents/${encodeURIComponent(id)}`, {
                method: 'DELETE',
                headers: {}
            });
            if (res.ok || res.status === 204) return;
            let msg = `Server responded ${res.status}`;
            try { const j = await res.json(); if (j?.message) msg = j.message; } catch { }
            throw new Error(msg);
        }

        async function load() {
            listEl.setAttribute('aria-busy', 'true');
            try {
                const r = await fetch('/api/documents');
                let data, text;
                try { data = await r.json(); } catch { text = await r.text(); try { data = JSON.parse(text); } catch { data = null; } }

                if (!r.ok) {
                    statusEl.textContent = `API error ${r.status}`;
                    statusEl.style.background = '#fee2e2';
                    statusEl.style.color = '#991b1b';
                } else {
                    statusEl.textContent = 'API connected';
                    statusEl.style.background = '#d1fae5';
                    statusEl.style.color = '#065f46';
                }

                renderDocs(Array.isArray(data) ? data : []);
            } catch (err) {
                statusEl.textContent = 'Could not reach API';
                statusEl.style.background = '#fee2e2';
                statusEl.style.color = '#991b1b';
                listEl.innerHTML = `
                      <div class="empty">
                        <div style="font-weight:600">Connection error</div>
                        <div class="muted" style="margin-top:6px">${String(err)}</div>
                        <div class="muted" style="margin-top:6px">Is the API container running?</div>
                      </div>`;
            } finally {
                listEl.removeAttribute('aria-busy');
            }
        }

        function renderDocs(data) {
            listEl.innerHTML = '';
            if (data.length === 0) {
                countEl.textContent = '0 items';
                const empty = document.createElement('div');
                empty.className = 'empty';
                empty.innerHTML = `No documents yet.<br>`;
                listEl.appendChild(empty);
                return;
            }
            countEl.textContent = data.length + (data.length === 1 ? ' item' : ' items');
            for (const doc of data) {
                const card = document.createElement('div');
                card.className = 'doc';
                card.setAttribute('data-id', doc.id);
                card.innerHTML = `
                      <button class="del" aria-label="Delete ${doc.fileName}">
                        <span aria-hidden="true">✕</span>
                      </button>
                      <div class="icon">${extIcon(doc.fileName, doc.contentType)}</div>
                      <div>
                        <div style="font-weight:600; display:flex; gap:8px; align-items:center; flex-wrap:wrap">
                          <a class="doc-link" href="#" title="Open document">${doc.fileName || '(unnamed file)'}</a>
                        </div>
                        <div class="meta">${fmtBytes(doc.sizeBytes)} • ${doc.contentType || '-'} • ${fmtDate(doc.uploadedAt)}</div>
                        <div class="row" style="margin-top:8px">
                          <span class="pill">id: ${String(doc.id).slice(0, 8)}…</span>
                          <button class="btn-ghost btn" type="button" data-ocr>OCR</button>
                        </div>

                      </div>
                    `;

                //----------------------------------------------------------------------------------OCR---------------------------------------------------------------------------
                const ocrBtn = card.querySelector('[data-ocr]');
                const delBtn = card.querySelector('.del');
                listEl.appendChild(card);
                ocrBtn.disabled = false;
                delBtn.disabled = false;


                ocrBtn.addEventListener('click', async () => {
                    ocrBtn.disabled = true;
                    delBtn.disabled = true;

                    showOcrToast(`Starting OCR for ${doc.fileName}…`);

                    ocrResultText.textContent = 'OCR loading...';

                    try {
                        const res = await fetch(`/api/ocr/run/${doc.id}`, { method: 'POST' });

                        if (!res.ok && res.status !== 202)
                            throw new Error(`OCR star failed (${res.status})`);

                        showOcrToast(`OCR is running for ${doc.fileName}…`);

                        await pollOcrResult(doc.id, doc.fileName, delBtn);
                    } catch (err) {
                        console.error(err);
                        hideOcrToast();
                        alert(`OCR failed: ${err.message}`);
                        ocrResultText.textContent = 'OCR failed.';
                        delBtn.disabled = false;
                    } finally {
                        ocrBtn.disabled = false;
                    }
                });
                //-------------------------------------------------------------------------------------------------------------------------------------------------------------
                delBtn.addEventListener('click', async () => {
                    if (!confirm(`Delete document ${doc.fileName}?`)) return;
                    try {
                        await apiDeleteDocument(doc.id);
                        toast(`Deleted ${doc.fileName}`);
                        card.remove();
                        updateCount();
                        resetOcrResult();
                    } catch (err) {
                        console.error(err);
                        alert(`Failed to delete: ${err.message}`);
                    }
                });


            }
        }

        function updateCount() {
            const items = listEl.querySelectorAll('.doc');
            const n = items.length;
            countEl.textContent = n + (n === 1 ? ' item' : ' items');
            if (n === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty';
                empty.textContent = 'No documents yet.';
                listEl.appendChild(empty);
            }
        }

        const queue = [];

        function addToQueue(files) {
            for (const f of files) {
                if (f.size > 10 * 1024 * 1024) {
                    toast(`${f.name} is larger than 10 MB`);
                    continue;
                }
                const id = crypto.randomUUID();
                queue.push({ id, file: f, progress: 0, state: 'queued' });
            }
            renderQueue();
        }

        function renderQueue() {
            queueEl.innerHTML = '';
            if (queue.length === 0) { startBtn.disabled = true; return; }
            startBtn.disabled = false;
            for (const item of queue) {
                const row = document.createElement('div');
                row.className = 'q-item';
                row.setAttribute('data-id', item.id);
                row.innerHTML = `
                      <div>
                        <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap">
                          <strong>${item.file.name}</strong>
                          <span class="pill">${fmtBytes(item.file.size)}</span>
                          <span class="pill">${item.file.type || 'unknown'}</span>
                        </div>
                      </div>
                      <button class="btn-ghost btn" type="button" data-remove>Remove</button>
                    `;
                row.querySelector('[data-remove]').addEventListener('click', () => {
                    const idx = queue.findIndex(q => q.id === item.id);
                    if (idx >= 0) { queue.splice(idx, 1); renderQueue(); fileInput.value = ''; }
                });
                queueEl.appendChild(row);
            }
        }

        chooseBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => addToQueue(e.target.files));

        ;['dragenter', 'dragover'].forEach(ev => dropEl.addEventListener(ev, (e) => {
            e.preventDefault(); e.stopPropagation(); dropEl.classList.add('dragover');
        }));
        ;['dragleave', 'drop'].forEach(ev => dropEl.addEventListener(ev, (e) => {
            e.preventDefault(); e.stopPropagation(); dropEl.classList.remove('dragover');
        }));
        dropEl.addEventListener('drop', (e) => addToQueue(e.dataTransfer.files));

        async function uploadQueuedFiles() {
            if (!queue.length) return;

            const fd = new FormData();
            for (const item of queue) {
                fd.append('files[]', item.file, item.file.name);
            }

            const res = await fetch('/api/documents/upload', {
                method: 'POST',
                body: fd
            });

            if (!res.ok) {
                const txt = await res.text().catch(() => '');
                throw new Error(`Upload failed (${res.status}) ${txt}`);
            }
            return await res.json();
        }

        startBtn.addEventListener('click', async () => {
            if (!queue.length) return;

            try {
                const result = await uploadQueuedFiles();
                toast(`Uploaded ${Array.isArray(result) ? result.length : queue.length} file(s)`);

                queue.length = 0;
                renderQueue();
                await load();

            } catch (err) {
                console.error(err);
                alert(err.message || 'Upload failed');
                return;
            }
        });

        //-------------------------------------------------------------------------------------------OCR----------------------------------------------------------------------------
        async function pollOcrResult(docId, fileName, delBtn) {
            showOcrToast("Running OCR…");
            ocrResultText.textContent = "OCR is running, please wait…";
            summaryResultText.textContent = "Preparing summary…";


            const pollIntervalMs = 2000;
            const maxDurationMs = 5 * 60 * 1000;
            const startTime = Date.now();

            while (Date.now() - startTime < maxDurationMs) {
                try {
                    const res = await fetch(`/api/ocr/result/${docId}`);

                    if (res.status === 200) {
                        const data = await res.json();

                        const ocrText = data.ocrText || "(no OCR text)";
                        const summary = data.summary || "(no summary available)";

                        ocrResultText.textContent = ocrText;
                        summaryResultText.textContent = summary;

                        hideOcrToast();
                        delBtn.disabled = false; 
                        toast(`OCR & Summary done for file ${fileName}`);
                        return;
                    } else if (res.status === 202) {
                        console.log(`OCR still runnning for file ${fileName}...`);
                    } else if (res.status === 500) {
                        const errText = await res.text();
                        ocrResultText.textContent = `Error with OCR: ${errText}`;
                        hideOcrToast();
                        delBtn.disabled = false; 
                        return;
                    } else {
                        console.warn(`Unexpected status: ${res.status}`);
                    }

                } catch (err) {
                    console.error("Polling-Error:", err);
                    ocrResultText.textContent = `Connection Error with OCR (${err.message})`;
                    hideOcrToast();
                    delBtn.disabled = false; 
                    return;
                }

                await new Promise(r => setTimeout(r, pollIntervalMs));
            }

            ocrResultText.textContent = `No OCR-Result for file ${fileName} (Timeout after 5 minutes).`;
            summaryResultText.textContent = "(No Summary)";
            hideOcrToast();
            delBtn.disabled = false; 
            toast(`OCR timeout for ${fileName}`);
        }

        //----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        function resetOcrResult() {
            ocrResultText.textContent = 'No OCR Request';
            summaryResultText.textContent = 'No summary available';
            hideOcrToast();
        }



        const searchInput = document.getElementById('searchInput');
        const clearSearchBtn = document.getElementById('clearSearchBtn');

        searchInput.addEventListener('input', async () => {
            const query = searchInput.value.trim();

            if (query.length === 0) {
                await load();
                return;
            }

            try {
                const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                const data = await res.json();

                if (Array.isArray(data)) {
                    renderDocs(data);
                } else {
                    renderDocs([]);
                }
            } catch (err) {
                console.error("Search error:", err);
                renderDocs([]);
            }
        });

        clearSearchBtn.addEventListener('click', async () => {
            searchInput.value = '';
            await load();
        });


        load();
    </script>
</body>
</html>
